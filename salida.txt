WITH vacancies AS
(
          SELECT    ts.flight_id,
                    ts.n_seats - COALESCE(os.n_seats, 0) AS n_seats
          FROM      (
                             SELECT   flight_id,
                                      Count(*) AS n_seats
                             FROM     flights f 
                             NATURAL JOIN     seats s
                             GROUP BY flight_id) ts
          LEFT JOIN
                    (
                             SELECT   flight_id,
                                      Count(*) AS n_seats
                             FROM     boarding_passes 
                             NATURAL JOIN     flights
                             GROUP BY flight_id) os
          ON        os.flight_id = ts.flight_id ), direct_flights AS
(
         SELECT   f.flight_id,
                  NULL::int AS flight_id2,
                  v.n_seats,
                  0 AS connection_flights,
                  departure_airport,
                  NULL AS connection_airport,
                  arrival_airport,
                  scheduled_departure AS flight_1_departure,
                  scheduled_arrival AS flight_1_arrival,
                  NULL::timestamp AS flight_2_departure,
                  NULL::timestamp AS flight_2_arrival,
                  scheduled_arrival - scheduled_departure AS time_elapsed,
                  f.aircraft_code AS f1_aircraft,
                  NULL AS f2_aircraft
         FROM     flights f
         JOIN     vacancies v
         ON       v.flight_id = f.flight_id
         WHERE    departure_airport = ?
         AND      arrival_airport = ?
         AND      scheduled_arrival - scheduled_departure <= interval '1 day'
         AND      scheduled_departure::date = ?
         ORDER BY time_elapsed ), indirect_flights AS
(
         SELECT   f1.flight_id,
                  f2.flight_id AS flight_id2,
                  Least(v1.n_seats, v2.n_seats) AS n_seats,
                  1                             AS connection_flights,
                  f1.departure_airport,
                  f1.arrival_airport AS connection_airport,
                  f2.arrival_airport,
                  f1.scheduled_departure AS flight_1_departure,
                  f1.scheduled_arrival AS flight_1_arrival,
                  f2.scheduled_departure AS flight_2_departure,
                  f2.scheduled_arrival AS flight_2_arrival,
                  f2.scheduled_arrival - f1.scheduled_departure AS time_elapsed,
                  f1.aircraft_code AS f1_aircraft,
                  f2.aircraft_code AS f2_aircraft
         FROM     flights f1
         JOIN     flights f2
         ON       f1.arrival_airport = f2.departure_airport
         JOIN     vacancies v1
         ON       f1.flight_id = v1.flight_id
         JOIN     vacancies v2
         ON       f2.flight_id = v2.flight_id
         WHERE    f1.departure_airport = ?
         AND      f2.arrival_airport = ?
         AND      f2.scheduled_departure >= f1.scheduled_arrival
         AND      f2.scheduled_arrival - f1.scheduled_departure <= interval '1 day'
         AND      f1.scheduled_departure::date = ?
         ORDER BY time_elapsed ), total_flights AS
(
       SELECT *
       FROM   direct_flights
       UNION
       SELECT *
       FROM   indirect_flights )
SELECT   flight_id AS "Flight",
         n_seats AS "Seat",
         connection_flights AS "Connections",
         flight_1_departure AS "Departure1",
         flight_1_arrival AS "Arrival1",
         flight_2_departure AS "Departure2",
         flight_2_arrival AS "Arrival2",
         time_elapsed AS "Duration",
         f1_aircraft AS "Aircraft1",
         f2_aircraft AS "Aircraft2",
         flight_id2 AS "Flight2"
FROM     total_flights
WHERE    n_seats != 0
ORDER BY time_elapsed, flight_1_departure;
